'use strict';

// Configuration
const config = require('../config/config.js');

// External dependecies
const debug = require('debug')('bot');
const waterfall = require('async/waterfall');
const leagueApi = require('../lib/riot-api-wrapper');

const league = new leagueApi(config.RIOT_API_KEY);

const _processGames = function(games) {

    // TODO: don't create HTML here!!! Return simple object only
    let response = '<ul>';
    let stats = "";

    for (let value of games) {

        stats = (value.stats.championsKilled || 0) + "/" + (value.stats.numDeaths || 0) + "/" + (value.stats.assists || 0)+ " - ðŸ’°" + (value.stats.goldEarned || 0);
        response += "<li class=\"" + (value.stats.win?"won":"lost") + "\">" + new Date(value.createDate) + " - " + (value.stats.win?"âœ…":"ðŸš«") + " - " + stats + "</li>";
    }
    response += "</ul>";
    return response;
};

function showGameResults(summonerName, mainCallback) {

    waterfall([
        function (callback) {
            league.getSummonersByName('euw', summonerName, function(err, data) {
                const summonerId = data[summonerName].id;
                debug("Got summonerId: " + summonerId);
                callback(null, summonerId);
            });
        },
        function (summonerId) {
            league.getRecentGames('euw', summonerId, function(err, data) {
                mainCallback(null, _processGames(data.games));
            });
        }
    ], function(err, result){
        debug(err);
        debug(result);
    });
}

function showGameResults_fake(summonerName, mainCallback) {
    const obj = {"summonerId":86950135,"games":[{"gameId":2887105280,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"BOT_3x3","mapId":10,"teamId":100,"championId":21,"spell1":7,"spell2":4,"level":30,"ipEarned":248,"createDate":1476562845450,"fellowPlayers":[{"summonerId":59016919,"teamId":100,"championId":136},{"summonerId":92238478,"teamId":100,"championId":30}],"stats":{"level":18,"goldEarned":15479,"numDeaths":18,"barracksKilled":1,"turretsKilled":3,"minionsKilled":204,"championsKilled":1,"goldSpent":15049,"totalDamageDealt":196520,"totalDamageTaken":45042,"team":100,"win":true,"neutralMinionsKilled":2,"largestMultiKill":1,"physicalDamageDealtPlayer":174318,"magicDamageDealtPlayer":21750,"physicalDamageTaken":38477,"magicDamageTaken":6289,"largestCriticalStrike":462,"timePlayed":3269,"totalHeal":3450,"totalUnitsHealed":3,"assists":12,"item0":3085,"item1":2031,"item2":3006,"item3":3078,"item4":3078,"item5":3078,"item6":3348,"magicDamageDealtToChampions":2442,"physicalDamageDealtToChampions":17353,"totalDamageDealtToChampions":20245,"trueDamageDealtPlayer":449,"trueDamageDealtToChampions":449,"trueDamageTaken":276,"neutralMinionsKilledEnemyJungle":1,"neutralMinionsKilledYourJungle":1,"totalTimeCrowdControlDealt":370,"playerRole":2,"playerPosition":2,"totalDamageDealtToBuildings":9318}},{"gameId":2884408984,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"NORMAL_3x3","mapId":10,"teamId":100,"championId":21,"spell1":7,"spell2":4,"level":30,"ipEarned":50,"createDate":1476414316357,"fellowPlayers":[{"summonerId":38640474,"teamId":200,"championId":102},{"summonerId":20340669,"teamId":100,"championId":86},{"summonerId":31698098,"teamId":200,"championId":99},{"summonerId":38650330,"teamId":200,"championId":106},{"summonerId":40780841,"teamId":100,"championId":238}],"stats":{"level":11,"goldEarned":5112,"numDeaths":13,"minionsKilled":38,"goldSpent":4550,"totalDamageDealt":30654,"totalDamageTaken":19166,"team":100,"win":false,"physicalDamageDealtPlayer":28211,"magicDamageDealtPlayer":2442,"physicalDamageTaken":9891,"magicDamageTaken":8727,"largestCriticalStrike":289,"timePlayed":1489,"totalHeal":837,"totalUnitsHealed":3,"assists":5,"item0":3006,"item1":2031,"item2":3085,"item3":1036,"item4":1036,"item6":3348,"magicDamageDealtToChampions":554,"physicalDamageDealtToChampions":5243,"totalDamageDealtToChampions":5798,"trueDamageTaken":548,"totalTimeCrowdControlDealt":70,"playerRole":4,"playerPosition":4}},{"gameId":2884426650,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"NORMAL_3x3","mapId":10,"teamId":200,"championId":21,"spell1":7,"spell2":4,"level":30,"ipEarned":44,"createDate":1476412571442,"fellowPlayers":[{"summonerId":20665895,"teamId":100,"championId":20},{"summonerId":20747984,"teamId":100,"championId":60},{"summonerId":31958612,"teamId":100,"championId":222},{"summonerId":26280232,"teamId":200,"championId":222},{"summonerId":81224886,"teamId":200,"championId":25}],"stats":{"level":8,"goldEarned":2965,"numDeaths":9,"minionsKilled":35,"goldSpent":2650,"totalDamageDealt":24047,"totalDamageTaken":12353,"team":200,"win":false,"physicalDamageDealtPlayer":20332,"magicDamageDealtPlayer":3714,"physicalDamageTaken":6991,"magicDamageTaken":5201,"largestCriticalStrike":114,"timePlayed":891,"totalHeal":764,"totalUnitsHealed":2,"item0":3006,"item1":2031,"item2":1043,"item3":1051,"item6":3348,"magicDamageDealtToChampions":267,"physicalDamageDealtToChampions":2751,"totalDamageDealtToChampions":3019,"trueDamageTaken":160,"totalTimeCrowdControlDealt":108,"playerRole":2,"totalDamageDealtToBuildings":99}},{"gameId":2884408118,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"BOT_3x3","mapId":10,"teamId":100,"championId":21,"spell1":7,"spell2":4,"level":30,"ipEarned":19,"createDate":1476411267651,"fellowPlayers":[{"summonerId":63721029,"teamId":100,"championId":13},{"summonerId":65481163,"teamId":100,"championId":15}],"stats":{"level":5,"goldEarned":3266,"numDeaths":3,"barracksKilled":1,"turretsKilled":1,"minionsKilled":12,"championsKilled":1,"goldSpent":3050,"totalDamageDealt":11199,"totalDamageTaken":4618,"team":100,"win":true,"largestMultiKill":1,"physicalDamageDealtPlayer":9678,"magicDamageDealtPlayer":1520,"physicalDamageTaken":3613,"magicDamageTaken":966,"timePlayed":617,"totalHeal":504,"totalUnitsHealed":3,"assists":2,"item0":3006,"item1":2031,"item2":2015,"item3":2015,"item4":1042,"item6":3348,"magicDamageDealtToChampions":194,"physicalDamageDealtToChampions":823,"totalDamageDealtToChampions":1018,"trueDamageTaken":38,"totalTimeCrowdControlDealt":34,"playerRole":1,"totalDamageDealtToBuildings":3913}},{"gameId":2884398116,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"BOT_3x3","mapId":10,"teamId":100,"championId":21,"spell1":7,"spell2":4,"level":30,"ipEarned":168,"createDate":1476410470350,"fellowPlayers":[{"summonerId":83968780,"teamId":100,"championId":29},{"summonerId":65481163,"teamId":100,"championId":15}],"stats":{"level":8,"goldEarned":4476,"numDeaths":2,"minionsKilled":30,"championsKilled":1,"goldSpent":2250,"totalDamageDealt":24920,"totalDamageTaken":5697,"team":100,"win":true,"largestMultiKill":1,"physicalDamageDealtPlayer":23590,"magicDamageDealtPlayer":1330,"physicalDamageTaken":3195,"magicDamageTaken":2501,"largestCriticalStrike":196,"timePlayed":782,"totalHeal":688,"totalUnitsHealed":2,"assists":4,"item0":3006,"item1":2031,"item2":1043,"item6":3348,"magicDamageDealtToChampions":362,"physicalDamageDealtToChampions":5409,"totalDamageDealtToChampions":5772,"totalTimeCrowdControlDealt":32,"playerRole":2,"totalDamageDealtToBuildings":4106}},{"gameId":2876201243,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"NORMAL_3x3","mapId":10,"teamId":200,"championId":21,"spell1":7,"spell2":4,"level":30,"ipEarned":96,"createDate":1475920733676,"fellowPlayers":[{"summonerId":85236920,"teamId":100,"championId":202},{"summonerId":86180920,"teamId":100,"championId":122},{"summonerId":86100998,"teamId":200,"championId":122},{"summonerId":90318837,"teamId":100,"championId":54},{"summonerId":24907043,"teamId":200,"championId":9}],"stats":{"level":14,"goldEarned":8988,"numDeaths":7,"turretsKilled":1,"minionsKilled":99,"championsKilled":2,"goldSpent":9000,"totalDamageDealt":79442,"totalDamageTaken":22116,"team":200,"win":true,"neutralMinionsKilled":4,"largestMultiKill":1,"physicalDamageDealtPlayer":72625,"magicDamageDealtPlayer":6816,"physicalDamageTaken":18687,"magicDamageTaken":3239,"largestCriticalStrike":320,"timePlayed":2044,"totalHeal":2569,"totalUnitsHealed":3,"assists":4,"item0":3006,"item1":2031,"item2":3072,"item3":3046,"item4":3133,"item6":3348,"magicDamageDealtToChampions":774,"physicalDamageDealtToChampions":7630,"totalDamageDealtToChampions":8405,"trueDamageTaken":190,"neutralMinionsKilledEnemyJungle":1,"neutralMinionsKilledYourJungle":3,"totalTimeCrowdControlDealt":179,"playerRole":4,"playerPosition":4,"totalDamageDealtToBuildings":3000}},{"gameId":2876148554,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"NORMAL_3x3","mapId":10,"teamId":200,"championId":21,"spell1":7,"spell2":4,"level":29,"ipEarned":44,"createDate":1475918390076,"fellowPlayers":[{"summonerId":20859685,"teamId":100,"championId":266},{"summonerId":87088341,"teamId":200,"championId":68},{"summonerId":90679474,"teamId":200,"championId":83},{"summonerId":90207438,"teamId":100,"championId":22},{"summonerId":20954770,"teamId":100,"championId":36}],"stats":{"level":7,"goldEarned":3563,"numDeaths":6,"turretsKilled":1,"minionsKilled":25,"goldSpent":2800,"totalDamageDealt":21197,"totalDamageTaken":9323,"team":200,"win":false,"physicalDamageDealtPlayer":18884,"magicDamageDealtPlayer":2312,"physicalDamageTaken":6794,"magicDamageTaken":2529,"largestCriticalStrike":244,"timePlayed":925,"totalHeal":622,"totalUnitsHealed":3,"assists":2,"item0":1001,"item1":2031,"item2":3133,"item3":3044,"item6":3348,"magicDamageDealtToChampions":520,"physicalDamageDealtToChampions":4617,"totalDamageDealtToChampions":5138,"totalTimeCrowdControlDealt":58,"playerRole":1,"totalDamageDealtToBuildings":807}},{"gameId":2876144941,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"NORMAL_3x3","mapId":10,"teamId":100,"championId":21,"spell1":7,"spell2":4,"level":29,"ipEarned":51,"createDate":1475917048560,"fellowPlayers":[{"summonerId":85307165,"teamId":200,"championId":122},{"summonerId":88938840,"teamId":100,"championId":45},{"summonerId":89617024,"teamId":200,"championId":74},{"summonerId":90959745,"teamId":200,"championId":81},{"summonerId":61511775,"teamId":100,"championId":2}],"stats":{"level":12,"goldEarned":6807,"numDeaths":7,"minionsKilled":56,"championsKilled":5,"goldSpent":6250,"totalDamageDealt":47017,"totalDamageTaken":20249,"killingSprees":1,"largestKillingSpree":2,"team":100,"win":false,"largestMultiKill":1,"physicalDamageDealtPlayer":46441,"magicDamageDealtPlayer":577,"physicalDamageTaken":14148,"magicDamageTaken":4880,"largestCriticalStrike":350,"timePlayed":1513,"totalHeal":2108,"totalUnitsHealed":3,"assists":5,"item0":3006,"item1":2031,"item2":3071,"item3":3086,"item4":1042,"item5":1042,"item6":3348,"magicDamageDealtToChampions":305,"physicalDamageDealtToChampions":10949,"totalDamageDealtToChampions":11254,"trueDamageTaken":1221,"totalTimeCrowdControlDealt":722,"playerRole":4,"playerPosition":2,"totalDamageDealtToBuildings":911}},{"gameId":2876109543,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"NORMAL_3x3","mapId":10,"teamId":100,"championId":21,"spell1":7,"spell2":4,"level":29,"ipEarned":55,"createDate":1475915353010,"fellowPlayers":[{"summonerId":90437994,"teamId":200,"championId":103},{"summonerId":89998417,"teamId":200,"championId":101},{"summonerId":88719114,"teamId":200,"championId":5},{"summonerId":89617024,"teamId":100,"championId":75},{"summonerId":79639628,"teamId":100,"championId":5}],"stats":{"level":12,"goldEarned":7092,"numDeaths":12,"turretsKilled":2,"minionsKilled":89,"goldSpent":6775,"totalDamageDealt":61445,"totalDamageTaken":21347,"team":100,"win":false,"physicalDamageDealtPlayer":59764,"magicDamageDealtPlayer":1681,"physicalDamageTaken":4905,"magicDamageTaken":13586,"largestCriticalStrike":302,"timePlayed":1700,"totalHeal":2534,"totalUnitsHealed":2,"assists":7,"item0":3006,"item1":2031,"item2":1038,"item3":3046,"item4":1018,"item5":1037,"item6":3348,"magicDamageDealtToChampions":652,"physicalDamageDealtToChampions":10143,"totalDamageDealtToChampions":10796,"trueDamageTaken":2855,"totalTimeCrowdControlDealt":33,"playerRole":2,"playerPosition":2,"totalDamageDealtToBuildings":812}},{"gameId":2876089104,"invalid":false,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","subType":"NORMAL_3x3","mapId":10,"teamId":200,"championId":21,"spell1":7,"spell2":4,"level":29,"ipEarned":96,"createDate":1475913385535,"fellowPlayers":[{"summonerId":84180710,"teamId":100,"championId":13},{"summonerId":76599897,"teamId":200,"championId":86},{"summonerId":89617024,"teamId":100,"championId":74},{"summonerId":88119638,"teamId":200,"championId":11},{"summonerId":91127160,"teamId":100,"championId":81}],"stats":{"level":14,"goldEarned":9611,"numDeaths":7,"barracksKilled":1,"turretsKilled":1,"minionsKilled":102,"championsKilled":5,"goldSpent":8350,"totalDamageDealt":83982,"totalDamageTaken":22311,"killingSprees":2,"largestKillingSpree":2,"team":200,"win":true,"neutralMinionsKilled":1,"largestMultiKill":1,"physicalDamageDealtPlayer":78153,"magicDamageDealtPlayer":5829,"physicalDamageTaken":8687,"magicDamageTaken":13623,"largestCriticalStrike":462,"timePlayed":2076,"totalHeal":4686,"totalUnitsHealed":3,"assists":7,"item0":3006,"item1":2031,"item2":3071,"item3":3046,"item4":3134,"item5":1036,"item6":3348,"magicDamageDealtToChampions":1316,"physicalDamageDealtToChampions":11515,"totalDamageDealtToChampions":12832,"neutralMinionsKilledEnemyJungle":1,"totalTimeCrowdControlDealt":573,"playerRole":2,"playerPosition":2,"totalDamageDealtToBuildings":3349}}]};
    // mainCallback(null, _processGames(obj.games));
    mainCallback(null, obj.games);
}

module.exports = {
    showGameResults,
    showGameResults_fake,
};
